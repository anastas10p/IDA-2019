---
title: "Case Study"
date: "31 August 2019"
output: html_document
---

<center>
**Group 04 members:**
</center>
<center> 
Philipp Herpich, Marina Matthaiou, Daniel Schewitz, Tatjana Stefanie Spanehl, Anastasios Tsigkros
</center>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

```

## Packages


We will use the `tidyverse` package to clean up our data, and the 'shiny' package to visualize the data.
```{r  results='hide', message=FALSE}
if( !require(tidyverse)){
  install.packages("tidyverse")
}
library(tidyverse)

if (!require(shiny)) {
  install.packages("shiny")
}
library(shiny)
```

## Import and Tidy
The necessary files are imported using the read.delim function. The data from each file is transformed into a tidy dataset by our function tidy_dataset. We get uniform data which allows an easier data manipulation and visualization. 

```{r tidy_dataset}

tidy_dataset <- function(component_data) {
  
  # Drop the columns that do not interest us.
  component_data <- select(component_data, -c(
    starts_with("Hersteller"),
    starts_with("Werks"),
    # ends_with("Fahrleistung"),
    starts_with("X")
  ))
  # ID:
  for (id_column in colnames(select(component_data, starts_with("ID")))) {
    component_data[[id_column]] <- as.character(component_data[[id_column]])
  }
  
  # Fehlerhaft
  for (faulty_column in colnames(select(component_data, starts_with("Fehlerhaft")))) {
    if (startsWith(faulty_column, "Fehlerhaft_Datum")) {
      component_data[[faulty_column]] <- as.Date(component_data[[faulty_column]], format = "%Y-%m-%d")
    } else if (startsWith(faulty_column, "Fehlerhaft_Fahrleistung")) {
      component_data[[faulty_column]] <- as.numeric(component_data[[faulty_column]])
    } else {
      component_data[[faulty_column]] <- as.logical(component_data[[faulty_column]])
    }
  }
  # Produktionsatum
  # If the date is set as an origin date:
  if ("origin" %in% colnames(component_data)) {
    for (production_date_column in colnames(select(component_data, starts_with("Produktionsdatum")))) {
      component_data[[paste("Produktionsdatum",
                            ifelse(is.na(strsplit(production_date_column, ".", fixed = TRUE)[[1]][2]),
                                   "", paste(".", strsplit(production_date_column, sep = ".", fixed = TRUE)[[1]][2])
                            ),
                            sep = ""
      )]] <-
        as.Date(component_data[[production_date_column]], origin = "1970-01-01")
    }
  } else {
    for (production_date_column in colnames(select(component_data, starts_with("Produktionsdatum")))) {
      component_data[[production_date_column]] <- as.Date(component_data[[production_date_column]], format = "%Y-%m-%d")
    }
  }
  
  # Create new clean columns
  # These commands are kept separate for readability's sake.
  
  id_cols <- Filter(
    Negate(function(x) is.null(unlist(x))),
    list(
      try(component_data[[colnames(select(component_data, starts_with("ID")))[1]]]),
      try(component_data[[colnames(select(component_data, starts_with("ID")))[2]]]),
      try(component_data[[colnames(select(component_data, starts_with("ID")))[3]]])
    )
  )
  component_data$id <- as.factor(coalesce(!!!id_cols))
  
  production_date_cols <- Filter(
    Negate(function(x) is.null(unlist(x))),
    list(
      try(component_data$Produktionsdatum),
      try(component_data$Produktionsdatum.x),
      try(component_data$Produktionsdatum.y)
    )
  )
  component_data$production_date <- coalesce(!!!production_date_cols)
  
  faulty_date_cols <- Filter(
    Negate(function(x) is.null(unlist(x))),
    list(
      try(component_data$Fehlerhaft_Datum),
      try(component_data$Fehlerhaft_Datum.x),
      try(component_data$Fehlerhaft_Datum.y)
    )
  )
  component_data$faulty_date <- coalesce(!!!faulty_date_cols)
  
  distance_cols <- Filter(
    Negate(function(x) is.null(unlist(x))),
    list(
      try(component_data$Fehlerhaft_Fahrleistung),
      try(component_data$Fehlerhaft_Fahrleistung.x),
      try(component_data$Fehlerhaft_Fahrleistung.y)
    )
  )
  component_data$distance <- coalesce(!!!distance_cols)
  
  faulty_cols <- Filter(
    Negate(function(x) is.null(unlist(x))),
    list(
      try(component_data$Fehlerhaft),
      try(component_data$Fehlerhaft.x),
      try(component_data$Fehlerhaft.y)
    )
  )
  component_data$faulty <- coalesce(!!!faulty_cols)
  
  component_data$production_year <- as.factor(lubridate::year(component_data$production_date))
  component_data$production_week <- lubridate::week(component_data$production_date)
  
  # Fill the producer and factory column using the id data.
  component_data_clean <- component_data %>%
    separate(id, c("id", "producer", "factory", "count"), "-") %>%
    select(c(
      "id", "producer", "factory", "faulty",
      "production_year", "production_week", "faulty_date"
    ))
  rm(component_data)
  
  component_data_clean$id <- as.factor(component_data_clean$id)
  component_data_clean$producer <- as.numeric(component_data_clean$producer)
  component_data_clean$factory <- as.numeric(component_data_clean$factory)
  component_data_clean
}

```

The data of every component file is stored in a seperate tibble.

```{r import, eval = FALSE}

component_tibbles <- vector(mode = "list", length = 16)
names(component_tibbles) <- c(
  "K1BE1", "K1BE2", "K1DI1", "K1DI2",
  "K2LE1", "K2LE2", "K2ST1", "K2ST2",
  "K3AG1", "K3AG2", "K3SG1", "K3SG2",
  "K4", "K5", "K6", "K7")
```
Some files had formats that allowed a direct reading, while others needed some preparation. 
```{r reading the files, eval = FALSE}
#read data using read.delim and the separators 
#K1
component_tibbles$K1BE1 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K1BE1.csv",sep = ""), head = TRUE, ","))
component_tibbles$K1BE2 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K1BE2.csv",sep = ""), head = TRUE, ";"))
component_tibbles$K1DI1 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K1DI1.csv",sep = ""), head = TRUE, ","))

#K1di2 
component_tibbles$K1DI2 <- readChar('Data/Komponente/Komponente_K1DI2.txt', file.info('Data/Komponente/Komponente_K1DI2.txt')$size)
component_tibbles$K1DI2 <- gsub('[[:blank:]]', '\\', component_tibbles$K1DI2)
component_tibbles$K1DI2 <- gsub('""', '"\n"', component_tibbles$K1DI2)
component_tibbles$K1DI2 <- tidy_dataset(read.delim(text = component_tibbles$K1DI2, header = TRUE , sep = '\\'))

#K2
component_tibbles$K2LE2 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K2LE2.txt",sep = ""), header = TRUE, "\\"))
component_tibbles$K2ST1 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K2ST1.txt",sep = ""), header = TRUE, "|"))
component_tibbles$K2ST2 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K2ST2.csv",sep = ""), header = TRUE, ";"))

#K2le1
component_tibbles$K2LE1 <- readChar('Data/Komponente/Komponente_K2LE1.txt', file.info('Data/Komponente/Komponente_K2LE1.txt')$size)
component_tibbles$K2LE1 <- gsub('\x0B"', '\n"', component_tibbles$K2LE1)
component_tibbles$K2LE1 <- gsub('II', ' ', component_tibbles$K2LE1)
component_tibbles$K2LE1 <- tidy_dataset(read.delim(text = component_tibbles$K2LE1, header = TRUE , sep = ' '))

#K3
component_tibbles$K3AG1 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K3AG1.csv",sep = ""), header = TRUE, ","))
component_tibbles$K3AG2 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K3AG2.txt", sep = ""), header = TRUE, "\\"))
component_tibbles$K3SG1 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K3SG1.csv",sep = ""), header = TRUE, ","))
component_tibbles$K3SG2 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K3SG2.csv",sep = ""), header = TRUE, ","))

#K4 -k7
component_tibbles$K4 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K4.csv", sep = ""), header = TRUE, ";"))
component_tibbles$K5 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K5.csv", sep = ""), header = TRUE, ","))
component_tibbles$K6 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K6.csv", sep = ""), header = TRUE, ";"))
component_tibbles$K7 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K7.txt", sep = ""), header = TRUE, "\t"))


```
Having read the data we produce three different dataframes for our analysis.

```{r prepare, eval = FALSE}

#dataframes for app
errors_by_id <- component_tibbles
for (component in 1:length(errors_by_id)){
  errors_by_id[[component]] <- errors_by_id[[component]] %>%
    group_by(id, producer, factory, production_year) %>%
    summarise(abs_error = sum(faulty, na.rm = TRUE), rel_error = abs_error/length(id))
}
errors_by_id <- bind_rows(errors_by_id)

errors_by_factory <- bind_rows(component_tibbles) %>%
  group_by(factory, production_year) %>%
  summarise(abs_error = sum(faulty, na.rm = TRUE), rel_error = abs_error/length(id))

errors_by_id_week <- component_tibbles
for (component in 1:length(errors_by_id_week)){
  errors_by_id_week[[component]] <- errors_by_id_week[[component]] %>%
    group_by(factory, production_year, production_week) %>%
    summarise(abs_error = sum(faulty, na.rm = TRUE), rel_error = abs_error/length(id)) %>%
    group_by(production_year, production_week) %>%
    mutate(total_error = sum(abs_error))
}
```
These steps result in our final dataset and we can start our analysis. We save the generated data in an .RData file.

``` {r save data, eval = FALSE}
save(errors_by_factory, errors_by_id, errors_by_id_week, file = "dataset_app.RData")
```


## Analysis  
In the following we look at the visualisation of our dataset to decide, where the next inspection should be carried out. We will be examining the last three years of production for which we have data, i.e. 2014, 2015 and 2016. We will look at the absolute and relative error rates of the factories, and then. For our visualization we use slight modifications of our Shiny application, therefore we import the shiny library and load the relevant data.

```{r data, echo = TRUE}
load("Additional_files_Group_04/dataset_app.RData")
```

**Absolute error rate**  
We produce the Pareto plots displaying the absolute error rates for the years we observe. Year selection has been limited, for a look outside this timeframe, refer to the Shiny application. 

```{r Absolute error rates, echo=FALSE}

# Pareto diagram to compare factories
#Data for 2014
y <- 2014
errors_by_factory_2014 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2014$error_data <- errors_by_factory_2014$abs_error
ymax <- 40000
sec_axis_factor <- 6
ylabel <- "Absolute Error"
errors_by_factory_2014 <- errors_by_factory_2014[order(errors_by_factory_2014$error_data, decreasing = TRUE), ]
errors_by_factory_2014$factory <- factor(errors_by_factory_2014$factory, levels = unique(errors_by_factory_2014$factory))
errors_by_factory_2014$cum_error <- cumsum(errors_by_factory_2014$error_data)
ggplot(errors_by_factory_2014, aes(x = errors_by_factory_2014$factory, y = errors_by_factory_2014$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2014$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2014$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2014$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2014$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2014$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2014", x = "Factories", y = ylabel) +
  theme(legend.position = "none")

#Data for 2015
y <- 2015
errors_by_factory_2015 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2015$error_data <- errors_by_factory_2015$abs_error
ymax <- 40000
sec_axis_factor <- 6
ylabel <- "Absolute Error"
errors_by_factory_2015 <- errors_by_factory_2015[order(errors_by_factory_2015$error_data, decreasing = TRUE), ]
errors_by_factory_2015$factory <- factor(errors_by_factory_2015$factory, levels = unique(errors_by_factory_2015$factory))
errors_by_factory_2015$cum_error <- cumsum(errors_by_factory_2015$error_data)
ggplot(errors_by_factory_2015, aes(x = errors_by_factory_2015$factory, y = errors_by_factory_2015$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2015$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2015$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2015$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2015$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2015$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2015", x = "Factories", y = ylabel) +
  theme(legend.position = "none")
#Data for 2016
y <- 2016
errors_by_factory_2016 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2016$error_data <- errors_by_factory_2016$abs_error
ymax <- 40000
sec_axis_factor <- 6
ylabel <- "Absolute Error"
errors_by_factory_2016 <- errors_by_factory_2016[order(errors_by_factory_2016$error_data, decreasing = TRUE), ]
errors_by_factory_2016$factory <- factor(errors_by_factory_2016$factory, levels = unique(errors_by_factory_2016$factory))
errors_by_factory_2016$cum_error <- cumsum(errors_by_factory_2016$error_data)
ggplot(errors_by_factory_2016, aes(x = errors_by_factory_2016$factory, y = errors_by_factory_2016$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2016$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2016$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2016$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2016$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2016$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2016", x = "Factories", y = ylabel) +
  theme(legend.position = "none")

```

Throughout the last three years, the factories with the three highest absolute error rates are 1101, 1141, 1041, with 1141 and 1041 switching places. 

**Relative error rates**  
We now take a look at the relative error rates of the factories.

```{r Relative error rates}
# Pareto diagram to compare factories
#Data for 2014
y <- 2014
errors_by_factory_2014 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2014$error_data <- errors_by_factory_2014$rel_error
ymax <- 0.3
ylabel <- "Relative Error"
sec_axis_factor <- 6
errors_by_factory_2014 <- errors_by_factory_2014[order(errors_by_factory_2014$error_data, decreasing = TRUE), ]
errors_by_factory_2014$factory <- factor(errors_by_factory_2014$factory, levels = unique(errors_by_factory_2014$factory))
errors_by_factory_2014$cum_error <- cumsum(errors_by_factory_2014$error_data)
ggplot(errors_by_factory_2014, aes(x = errors_by_factory_2014$factory, y = errors_by_factory_2014$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2014$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2014$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2014$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2014$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2014$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2014", x = "Factories", y = ylabel) +
  theme(legend.position = "none")

#Data for 2015
y <- 2015
errors_by_factory_2015 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2015$error_data <- errors_by_factory_2015$rel_error
ymax <- 0.3
ylabel <- "Relative Error"
sec_axis_factor <- 6
errors_by_factory_2015 <- errors_by_factory_2015[order(errors_by_factory_2015$error_data, decreasing = TRUE), ]
errors_by_factory_2015$factory <- factor(errors_by_factory_2015$factory, levels = unique(errors_by_factory_2015$factory))
errors_by_factory_2015$cum_error <- cumsum(errors_by_factory_2015$error_data)
ggplot(errors_by_factory_2015, aes(x = errors_by_factory_2015$factory, y = errors_by_factory_2015$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2015$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2015$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2015$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2015$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2015$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2015", x = "Factories", y = ylabel) +
  theme(legend.position = "none")
#Data for 2016
y <- 2016
errors_by_factory_2016 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2016$error_data <- errors_by_factory_2016$rel_error
ymax <- 0.3
ylabel <- "Relative Error"
sec_axis_factor <- 6
errors_by_factory_2016 <- errors_by_factory_2016[order(errors_by_factory_2016$error_data, decreasing = TRUE), ]
errors_by_factory_2016$factory <- factor(errors_by_factory_2016$factory, levels = unique(errors_by_factory_2016$factory))
errors_by_factory_2016$cum_error <- cumsum(errors_by_factory_2016$error_data)
ggplot(errors_by_factory_2016, aes(x = errors_by_factory_2016$factory, y = errors_by_factory_2016$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2016$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2016$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2016$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2016$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2016$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2016", x = "Factories", y = ylabel) +
  theme(legend.position = "none")

```

The three factories with the highest relative error rates throughout the last three years were consistently 1111, 1011, 1041.  

We will take a closer look at factory 1041, since it is present in the top three of both categories.

**Components produced at factory 1041**

We need the components produced by factory 1041.

```{r factory 1041}
unique(subset(errors_by_id, factory == 1041)$id)
```

We will examine the absolute error rates for these components, each year presented separately. We start with the graphs displaying the weekly absolute error rates for the different components.
**2014:**
```{r absolute 2014 plots}

selected_year <- 2014

selected_component <- "K1BE1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

selected_component <- "K1BE2"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

selected_component <- "K1DI1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

```
**2015:**
```{r absolute 2015 plots}

selected_year <- 2015

selected_component <- "K1BE1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

selected_component <- "K1BE2"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory")

selected_component <- "K1DI1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)
```

**2016:**
```{r absolute 2016 plots}

selected_year <- 2016

selected_component <- "K1BE1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

selected_component <- "K1BE2"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

selected_component <- "K1DI1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

```

Factory 1041 has consistently the greatest error rate for components K1BE1, K1BE2 and shares the first place with factory 1031 for K1DI1. 

## Conclusion  

The data examined points to factory 1041 as the prime canditate for the next inpection. Over the last three years it had an overall high relative and absolute error rate. The number of faulty K1BE1 and K1BE2 components produced at 1041 are around double or more than the other factories producing them, whereas K1DI1 components of 1041 are no better than those produced at other factories. Given the fact that factory 1041 had the third highest relative error rate which coresponds to over 25000 faulty parts produced, we conclude that the next inspection should take place at factory 1041.