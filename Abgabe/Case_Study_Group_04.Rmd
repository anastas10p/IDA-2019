---
title: "Case Study"
date: "31 August 2019"
output: html_document
---

<center>
**Group 04 members:**
</center>
<center> 
Philipp Herpich, Marina Matthaiou, Daniel Schewitz, Tatjana Stefanie Spanehl, Anastasios Tsigkros
</center>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

## Packages


We will use the `tidyverse` package to clean up our data, and the `shiny` package to visualize the data.
```{r  results='hide', message=FALSE}
if( !require(tidyverse)){
  install.packages("tidyverse")
}
library(tidyverse)

if (!require(shiny)) {
  install.packages("shiny")
}
library(shiny)
```

## Import and Tidy
The necessary files are imported using the read.delim function. The data from each file is transformed into a tidy dataset by our function tidy_dataset. We get uniform data which allows an easier data manipulation and visualization. 

```{r tidy_dataset}
tidy_dataset <- function(component_data) {
  
  # Drop the columns that do not interest us.
  component_data <- select(component_data, -c(
    starts_with("Hersteller"),
    starts_with("Werks"),
    # ends_with("Fahrleistung"),
    starts_with("X")
  ))
  # Get the ID columns
  for (id_column in colnames(select(component_data, starts_with("ID")))) {
    component_data[[id_column]] <- as.character(component_data[[id_column]])
  }
  
  # Get the Fehlerhaft columns.
  # These describe:
  # 1)whether or not a component was faulty
  # 2)if yes, when the component broke down and
  # 3)the distance covered until that point. 
  for (faulty_column in colnames(select(component_data, starts_with("Fehlerhaft")))) {
    if (startsWith(faulty_column, "Fehlerhaft_Datum")) {
      component_data[[faulty_column]] <- as.Date(component_data[[faulty_column]], format = "%Y-%m-%d")
    } else if (startsWith(faulty_column, "Fehlerhaft_Fahrleistung")) {
      component_data[[faulty_column]] <- as.numeric(component_data[[faulty_column]])
    } else {
      component_data[[faulty_column]] <- as.logical(component_data[[faulty_column]])
    }
  }
  
  # Get the Produktionsatum columns
  # If the date is set as an origin date:
  if ("origin" %in% colnames(component_data)) {
    for (production_date_column in colnames(select(component_data, starts_with("Produktionsdatum")))) {
      component_data[[paste("Produktionsdatum",
                            ifelse(is.na(strsplit(production_date_column, ".", fixed = TRUE)[[1]][2]),
                                   "", paste(".", strsplit(production_date_column, sep = ".", fixed = TRUE)[[1]][2])
                            ),
                            sep = ""
      )]] <-
        as.Date(component_data[[production_date_column]], origin = "1970-01-01")
    }
  } else {
    # If the date was given in a "regular" format:
    for (production_date_column in colnames(select(component_data, starts_with("Produktionsdatum")))) {
      component_data[[production_date_column]] <- as.Date(component_data[[production_date_column]], format = "%Y-%m-%d")
    }
  }
  
  # Create new clean columns from the data gathered
  
  # These commands are kept separate for readability's sake.
  
  # ID columns:
  id_cols <- Filter(
    Negate(function(x) is.null(unlist(x))),
    list(
      try(component_data[[colnames(select(component_data, starts_with("ID")))[1]]]),
      try(component_data[[colnames(select(component_data, starts_with("ID")))[2]]]),
      try(component_data[[colnames(select(component_data, starts_with("ID")))[3]]])
    )
  )
  component_data$id <- as.factor(coalesce(!!!id_cols))
  
  # Production date columns:
  production_date_cols <- Filter(
    Negate(function(x) is.null(unlist(x))),
    list(
      try(component_data$Produktionsdatum),
      try(component_data$Produktionsdatum.x),
      try(component_data$Produktionsdatum.y)
    )
  )
  component_data$production_date <- coalesce(!!!production_date_cols)
  
  #Faulty date columns:
  faulty_date_cols <- Filter(
    Negate(function(x) is.null(unlist(x))),
    list(
      try(component_data$Fehlerhaft_Datum),
      try(component_data$Fehlerhaft_Datum.x),
      try(component_data$Fehlerhaft_Datum.y)
    )
  )
  component_data$faulty_date <- coalesce(!!!faulty_date_cols)
  
  # faulty columns
  faulty_cols <- Filter(
    Negate(function(x) is.null(unlist(x))),
    list(
      try(component_data$Fehlerhaft),
      try(component_data$Fehlerhaft.x),
      try(component_data$Fehlerhaft.y)
    )
  )
  component_data$faulty <- coalesce(!!!faulty_cols)
  
  # Production year and production week columns
  component_data$production_year <- as.factor(lubridate::year(component_data$production_date))
  component_data$production_week <- lubridate::week(component_data$production_date)
  
  # Fill the producer and factory column using the data from the id.
  component_data_clean <- component_data %>%
    separate(id, c("id", "producer", "factory", "count"), "-") %>%
    select(c(
      "id", "producer", "factory", "faulty",
      "production_year", "production_week", "faulty_date"
    ))
  
  # Remove the old dataset, since we no longer need it.
  rm(component_data)
  
  component_data_clean$id <- as.factor(component_data_clean$id)
  component_data_clean$producer <- as.numeric(component_data_clean$producer)
  component_data_clean$factory <- as.numeric(component_data_clean$factory)
  component_data_clean
}
```

The data of every component file is stored in a seperate tibble.

```{r import, eval = FALSE}

component_tibbles <- vector(mode = "list", length = 16)
names(component_tibbles) <- c(
  "K1BE1", "K1BE2", "K1DI1", "K1DI2",
  "K2LE1", "K2LE2", "K2ST1", "K2ST2",
  "K3AG1", "K3AG2", "K3SG1", "K3SG2",
  "K4", "K5", "K6", "K7")
```
Some files had formats that allowed a direct reading, while others needed some preparation. 
```{r reading the files, eval = FALSE}
#read data using read.delim and the separators 
#K1
component_tibbles$K1BE1 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K1BE1.csv", sep = ""), head = TRUE, ","))
component_tibbles$K1BE2 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K1BE2.csv",sep = ""), head = TRUE, ";"))
component_tibbles$K1DI1 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K1DI1.csv",sep = ""), head = TRUE, ","))

#K1di2 
component_tibbles$K1DI2 <- readChar('Data/Komponente/Komponente_K1DI2.txt', file.info('Data/Komponente/Komponente_K1DI2.txt')$size)
component_tibbles$K1DI2 <- gsub('[[:blank:]]', '\\', component_tibbles$K1DI2)
component_tibbles$K1DI2 <- gsub('""', '"\n"', component_tibbles$K1DI2)
component_tibbles$K1DI2 <- tidy_dataset(read.delim(text = component_tibbles$K1DI2, header = TRUE , sep = '\\'))

#K2
component_tibbles$K2LE2 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K2LE2.txt",sep = ""), header = TRUE, "\\"))
component_tibbles$K2ST1 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K2ST1.txt",sep = ""), header = TRUE, "|"))
component_tibbles$K2ST2 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K2ST2.csv",sep = ""), header = TRUE, ";"))

#K2le1
component_tibbles$K2LE1 <- readChar('Data/Komponente/Komponente_K2LE1.txt', file.info('Data/Komponente/Komponente_K2LE1.txt')$size)
component_tibbles$K2LE1 <- gsub('\x0B"', '\n"', component_tibbles$K2LE1)
component_tibbles$K2LE1 <- gsub('II', ' ', component_tibbles$K2LE1)
component_tibbles$K2LE1 <- tidy_dataset(read.delim(text = component_tibbles$K2LE1, header = TRUE , sep = ' '))

#K3
component_tibbles$K3AG1 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K3AG1.csv",sep = ""), header = TRUE, ","))
component_tibbles$K3AG2 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K3AG2.txt", sep = ""), header = TRUE, "\\"))
component_tibbles$K3SG1 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K3SG1.csv",sep = ""), header = TRUE, ","))
component_tibbles$K3SG2 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K3SG2.csv",sep = ""), header = TRUE, ","))

#K4 -k7
component_tibbles$K4 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K4.csv", sep = ""), header = TRUE, ";"))
component_tibbles$K5 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K5.csv", sep = ""), header = TRUE, ","))
component_tibbles$K6 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K6.csv", sep = ""), header = TRUE, ";"))
component_tibbles$K7 <-  tidy_dataset(read.delim(paste("Data/Komponente/Komponente_K7.txt", sep = ""), header = TRUE, "\t"))


```
Having read the data we produce three different dataframes for our analysis.

```{r prepare, eval = FALSE}

#dataframes for app
errors_by_id <- component_tibbles
for (component in 1:length(errors_by_id)){
  errors_by_id[[component]] <- errors_by_id[[component]] %>%
    group_by(id, producer, factory, production_year) %>%
    summarise(abs_error = sum(faulty, na.rm = TRUE), rel_error = abs_error/length(id))
}
errors_by_id <- bind_rows(errors_by_id)

errors_by_factory <- bind_rows(component_tibbles) %>%
  group_by(factory, production_year) %>%
  summarise(abs_error = sum(faulty, na.rm = TRUE), rel_error = abs_error/length(id))

errors_by_id_week <- component_tibbles
for (component in 1:length(errors_by_id_week)){
  errors_by_id_week[[component]] <- errors_by_id_week[[component]] %>%
    group_by(factory, production_year, production_week) %>%
    summarise(abs_error = sum(faulty, na.rm = TRUE), rel_error = abs_error/length(id)) %>%
    group_by(production_year, production_week) %>%
    mutate(total_error = sum(abs_error))
}
```
These steps result in our final dataset and we can start our analysis. We save the generated data in an .RData file.

``` {r save data, eval = FALSE}
save(errors_by_factory, errors_by_id, errors_by_id_week, file = "dataset_app.RData")
```


## Analysis  
In the following we look at the visualisation of our dataset to decide, where the next inspection should be carried out. We will be examining the last three years of production for which we have data, i.e. 2014, 2015 and 2016. We will look at the absolute and relative error rates of the factories, and then. For our visualization we use slight modifications of our Shiny application, therefore we import the shiny library and load the relevant data.

```{r data, echo = TRUE}
load("Additional_files_Group_04/dataset_app.RData")
```

**Absolute error rate**  
We produce the Pareto plots displaying the absolute error rates for the years we observe. Year selection has been limited, for a look outside this timeframe, refer to the Shiny application. 

```{r Absolute error rates, echo=FALSE}

# Pareto diagram to compare factories
#Data for 2014
y <- 2014
errors_by_factory_2014 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2014$error_data <- errors_by_factory_2014$abs_error
ymax <- 40000
sec_axis_factor <- 6
ylabel <- "Absolute Error"
errors_by_factory_2014 <- errors_by_factory_2014[order(errors_by_factory_2014$error_data, decreasing = TRUE), ]
errors_by_factory_2014$factory <- factor(errors_by_factory_2014$factory, levels = unique(errors_by_factory_2014$factory))
errors_by_factory_2014$cum_error <- cumsum(errors_by_factory_2014$error_data)
ggplot(errors_by_factory_2014, aes(x = errors_by_factory_2014$factory, y = errors_by_factory_2014$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2014$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2014$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2014$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2014$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2014$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2014", x = "Factories", y = ylabel) +
  theme(legend.position = "none")

#Data for 2015
y <- 2015
errors_by_factory_2015 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2015$error_data <- errors_by_factory_2015$abs_error
ymax <- 40000
sec_axis_factor <- 6
ylabel <- "Absolute Error"
errors_by_factory_2015 <- errors_by_factory_2015[order(errors_by_factory_2015$error_data, decreasing = TRUE), ]
errors_by_factory_2015$factory <- factor(errors_by_factory_2015$factory, levels = unique(errors_by_factory_2015$factory))
errors_by_factory_2015$cum_error <- cumsum(errors_by_factory_2015$error_data)
ggplot(errors_by_factory_2015, aes(x = errors_by_factory_2015$factory, y = errors_by_factory_2015$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2015$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2015$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2015$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2015$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2015$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2015", x = "Factories", y = ylabel) +
  theme(legend.position = "none")
#Data for 2016
y <- 2016
errors_by_factory_2016 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2016$error_data <- errors_by_factory_2016$abs_error
ymax <- 40000
sec_axis_factor <- 6
ylabel <- "Absolute Error"
errors_by_factory_2016 <- errors_by_factory_2016[order(errors_by_factory_2016$error_data, decreasing = TRUE), ]
errors_by_factory_2016$factory <- factor(errors_by_factory_2016$factory, levels = unique(errors_by_factory_2016$factory))
errors_by_factory_2016$cum_error <- cumsum(errors_by_factory_2016$error_data)
ggplot(errors_by_factory_2016, aes(x = errors_by_factory_2016$factory, y = errors_by_factory_2016$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2016$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2016$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2016$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2016$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2016$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2016", x = "Factories", y = ylabel) +
  theme(legend.position = "none")

```

Throughout the last three years, the factories with the three highest absolute error rates are 1101, 1141, 1041, with 1141 and 1041 switching places. 

**Relative error rates**  
We now take a look at the relative error rates of the factories.

```{r Relative error rates}
# Pareto diagram to compare factories
#Data for 2014
y <- 2014
errors_by_factory_2014 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2014$error_data <- errors_by_factory_2014$rel_error
ymax <- 0.3
ylabel <- "Relative Error"
sec_axis_factor <- 6
errors_by_factory_2014 <- errors_by_factory_2014[order(errors_by_factory_2014$error_data, decreasing = TRUE), ]
errors_by_factory_2014$factory <- factor(errors_by_factory_2014$factory, levels = unique(errors_by_factory_2014$factory))
errors_by_factory_2014$cum_error <- cumsum(errors_by_factory_2014$error_data)
ggplot(errors_by_factory_2014, aes(x = errors_by_factory_2014$factory, y = errors_by_factory_2014$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2014$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2014$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2014$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2014$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2014$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2014", x = "Factories", y = ylabel) +
  theme(legend.position = "none")

#Data for 2015
y <- 2015
errors_by_factory_2015 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2015$error_data <- errors_by_factory_2015$rel_error
ymax <- 0.3
ylabel <- "Relative Error"
sec_axis_factor <- 6
errors_by_factory_2015 <- errors_by_factory_2015[order(errors_by_factory_2015$error_data, decreasing = TRUE), ]
errors_by_factory_2015$factory <- factor(errors_by_factory_2015$factory, levels = unique(errors_by_factory_2015$factory))
errors_by_factory_2015$cum_error <- cumsum(errors_by_factory_2015$error_data)
ggplot(errors_by_factory_2015, aes(x = errors_by_factory_2015$factory, y = errors_by_factory_2015$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2015$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2015$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2015$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2015$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2015$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2015", x = "Factories", y = ylabel) +
  theme(legend.position = "none")
#Data for 2016
y <- 2016
errors_by_factory_2016 <- filter(errors_by_factory, production_year == y)
errors_by_factory_2016$error_data <- errors_by_factory_2016$rel_error
ymax <- 0.3
ylabel <- "Relative Error"
sec_axis_factor <- 6
errors_by_factory_2016 <- errors_by_factory_2016[order(errors_by_factory_2016$error_data, decreasing = TRUE), ]
errors_by_factory_2016$factory <- factor(errors_by_factory_2016$factory, levels = unique(errors_by_factory_2016$factory))
errors_by_factory_2016$cum_error <- cumsum(errors_by_factory_2016$error_data)
ggplot(errors_by_factory_2016, aes(x = errors_by_factory_2016$factory, y = errors_by_factory_2016$error_data)) +
  geom_bar(aes(fill = errors_by_factory_2016$factory), stat = "identity") +
  scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory_2016$cum_error / sec_axis_factor), name = "Cumulated")) +
  geom_point(aes(y = errors_by_factory_2016$cum_error / sec_axis_factor), size = 2) +
  geom_path(aes(y = errors_by_factory_2016$cum_error / sec_axis_factor, group = 1)) +
  geom_hline(yintercept = max(errors_by_factory_2016$cum_error / sec_axis_factor), linetype = "dashed") +
  labs(title = "Errors by factory for 2016", x = "Factories", y = ylabel) +
  theme(legend.position = "none")

```

The three factories with the highest relative error rates throughout the last three years were consistently 1111, 1011, 1041.  

We will take a closer look at factory 1041, since it is present in the top three of both categories.

**Components produced at factory 1041**

We need the components produced by factory 1041.

```{r factory 1041}
unique(subset(errors_by_id, factory == 1041)$id)
```

We will examine the absolute error rates for these components, each year presented separately. We start with the graphs displaying the weekly absolute error rates for the different components.
**2014:**
```{r absolute 2014 plots}

selected_year <- 2014

selected_component <- "K1BE1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

selected_component <- "K1BE2"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

selected_component <- "K1DI1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

```
**2015:**
```{r absolute 2015 plots}

selected_year <- 2015

selected_component <- "K1BE1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

selected_component <- "K1BE2"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory")

selected_component <- "K1DI1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)
```

**2016:**
```{r absolute 2016 plots}

selected_year <- 2016

selected_component <- "K1BE1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

selected_component <- "K1BE2"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

selected_component <- "K1DI1"
df <- data.frame(errors_by_id_week[[selected_component]]) %>%
  filter(production_year == selected_year)
df$factory <- factor(df$factory)
ggplot(df, aes(x = df$production_week, group = df$factory)) +
  geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
  geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
  geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
  labs(x = "Production Week", y = "Absolute Error", color = "Factory", title = selected_component)

```

Factory 1041 has consistently the greatest error rate for components K1BE1, K1BE2 and shares the first place with factory 1031 for K1DI1. 

## Conclusion  

The data examined points to factory 1041 as the prime canditate for the next inpection. Over the last three years it had an overall high relative and absolute error rate. The number of faulty K1BE1 and K1BE2 components produced at 1041 are around double or more than the other factories producing them, whereas K1DI1 components of 1041 are no better than those produced at other factories. Given the fact that factory 1041 had the third highest relative error rate which coresponds to over 25000 faulty parts produced, we conclude that the next inspection should take place at factory 1041. The product group examined should be components K1BE1 and K1BE2 given their high failure rate.

## Appendix: The Shiny application
We give the source code used in our Shiny application. Parts of this code have been modified and used in our analysis.

```{r shiny source, eval=FALSE}
if (!require(shiny)) {
  install.packages("shiny")
}
library(shiny)

if (!require(ggplot2)) {
  install.packages("ggplot2")
}
library(ggplot2)


if (!require(cowplot)) {
  install.packages("cowplot")
}
library(cowplot)

if (!require(dplyr)) {
  install.packages("dplyr")
}
library(dplyr)


load(paste(getwd(), "/Additional_files_Group_04/dataset_app.RData", sep = ""))
addResourcePath(prefix = "resources", directoryPath = "./Additional_files_Group_04")

############### UI ###############
ui <- fluidPage(

  # Application title
  titlePanel(title = div("Error Statistics: Factories and Components", img(src = "resources/images.png", height = "20%", width = "20%", align = "right"))),



  tabsetPanel(
    type = "tabs",
    tabPanel(
      "Info",
      img(src = "resources/car.jpeg", height = "40%", width = "40%", align = "center"),
      p(strong("Description")),
      p({
        "The present app is designed to cope with large amount of data in the automotive sector.
                           It helps identifying suppliers of certain components which have high error rates (absolute and relative)."
      }),
      br(),
      p(strong("Pareto Plots")),
      p({
        "In the tab \"Pareto Plots\", you can generate Pareto digrams which sort the factory and components, respectively in a descending order.
                           The upper Pareto diagram displays the error rates of the factory as a whole, meaning that
                           there is no distinction between the manufactured components within the factory. Beneath the 
                           Pareto diagram, you have the possibility to manually select individual factories in order to 
                           have a more detailed look on a component-sharp resolution."
      }),
      br(),
      p(strong("Error on component-sharp resolution")),
      p({
        "In the tab \"Error on component-sharp resolution\", you can select certain components in order to examine the distribution of 
                           absolute errors over the selcted time frame."
      }),
      br(),
      p(strong("Dataset")),
      p({
        "The tab \"Dataset\" displays a browsable table of the dataset that is used to generate the plots."
      })
    ),


    tabPanel(
      "Pareto Plots",
      # Scrollable tab

      fluidRow(
        column(
          width = 6,
          h4("Selection of the year"),
          # dropdown for production year
          selectInput("year", "Production Year:",
            choices = errors_by_id$production_year, selected = TRUE
          )
        ),
        column(
          width = 6,
          h4("Selction of error type"),
          # switch between rel/abs error
          selectInput("error", "Relative/Absolute Error", choices = list("Relative", "Absolute"))
        )
      ),

      plotOutput("Pareto1"),

      # checkboxes to choose factories
      fluidRow(
        column(
          width = 9,
          # Checkbox for factories
          checkboxGroupInput("factories", "Choose factories to show components:", unique(errors_by_id$factory), inline = TRUE),
          checkboxInput("all", "All")
        ),
        column(
          h6("Press \"Go\"-Button to display factories"),
          width = 3,
          # Go Buttom
          actionButton("go", "Go")
        )
      ),


      plotOutput("Pareto2", height = "600px")
    ),

    tabPanel(
      "Error on component-sharp resolution",

      fluidRow(
        column(
          width = 6,
          h4("Selection of the year"),
          # dropdown for production year
          selectInput("year_line", "Production Year:",
            choices = errors_by_id$production_year, selected = TRUE
          )
        ),
        column(
          width = 6,
          h4("Selection of the component"),
          # switch between rel/abs error
          selectInput("component", "Select component for detailed error plot", choices = names(errors_by_id_week))
        )
      ),

      plotOutput("Linediagram")
    ),


    tabPanel("Dataset", dataTableOutput("dataset"))
  )
)


############ server ###############
server <- function(input, output, session) {

  # select input to filter by year for pareto diagram
  year_input <- reactive({
    input$year
  })

  # Input for line diagram
  year_line_input <- reactive({
    input$year_line
  })

  error_input <- reactive({
    switch(input$error,
      "Relative" = "rel",
      "Absolute" = "abs"
    )
  })


  component_input <- reactive({
    input$component
  })


  # Pareto diagram to compare factories
  output$Pareto1 <- renderPlot({
    y <- year_input()
    errors_by_factory <- filter(errors_by_factory, production_year == y)
    e <- error_input()
    if (e == "rel") {
      errors_by_factory$error_data <- errors_by_factory$rel_error
      ymax <- 0.25
      sec_axis_factor <- 9
      ylabel <- "Relative Error"
    }
    if (e == "abs") {
      errors_by_factory$error_data <- errors_by_factory$abs_error
      ymax <- 40000
      sec_axis_factor <- 6
      ylabel <- "Absolute Error"
    }
    errors_by_factory <- errors_by_factory[order(errors_by_factory$error_data, decreasing = TRUE), ]
    errors_by_factory$factory <- factor(errors_by_factory$factory, levels = unique(errors_by_factory$factory))
    errors_by_factory$cum_error <- cumsum(errors_by_factory$error_data)
    ggplot(errors_by_factory, aes(x = errors_by_factory$factory, y = errors_by_factory$error_data)) +
      geom_bar(aes(fill = errors_by_factory$factory), stat = "identity") +
      scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(errors_by_factory$cum_error / sec_axis_factor), name = "Cumulated")) +
      geom_point(aes(y = errors_by_factory$cum_error / sec_axis_factor), size = 2) +
      geom_path(aes(y = errors_by_factory$cum_error / sec_axis_factor, group = 1)) +
      geom_hline(yintercept = max(errors_by_factory$cum_error / sec_axis_factor), linetype = "dashed") +
      labs(title = "Errors by Factory", x = "Factories", y = ylabel) +
      theme(legend.position = "none")
  })



  observe({
    updateCheckboxGroupInput(
      session, "factories",
      choices = unique(errors_by_id$factory), inline = TRUE,
      selected = if (input$all) unique(errors_by_id$factory)
    )
  })


  # Delay creation of plots via go button
  factory_plots <- eventReactive(input$go, {
    (input$factories)
  })

  # Pareto diagrams to compare components
  output$Pareto2 <- renderPlot({
    # define function for plotting the pareto diagram
    pareto <- function(df, f, e) {

      # filter factory
      df <- filter(df, factory == f)

      if (e == "rel") {
        df$error_data <- df$rel_error
        ymax <- 0.3
        ylabel <- "Relative Error"
      }
      if (e == "abs") {
        df$error_data <- df$abs_error
        ymax <- 25000
        ylabel <- "Absolute Error"
      }

      if (length(df$factory != 0)) {
        # descending order
        df <- df[order(df$error_data, decreasing = TRUE), ]

        # make factors for x-axis
        df$id <- factor(df$id, levels = unique(df$id))


        # new column cumulative relative error
        df$cum_error <- cumsum(df$error_data)

        # generate the Pareto chart
        ggplot(df, aes(x = df$id, y = df$error_data)) +
          geom_bar(aes(fill = df$id), stat = "identity", width = length(df$id) * 0.2) +
          scale_y_continuous(limits = c(0, ymax), sec.axis = sec_axis(~ . / max(df$cum_error / 2), name = "Cumulated")) +
          geom_point(aes(y = df$cum_error / 2), size = 2) +
          geom_path(aes(y = df$cum_error / 2, group = 1), size = 0.5) +
          labs(title = df$factory, x = "Components", y = ylabel) +
          theme(legend.position = "none", aspect.ratio = 1) +
          scale_fill_manual(values = c(
            "K1BE1" = colors()[10], "K1BE2" = colors()[20], "K1DI1" = colors()[50], "K1DI2" = colors()[55],
            "K2LE1" = colors()[95], "K2LE2" = colors()[100], "K2ST1" = colors()[30],
            "K2ST2" = colors()[80], "K3AG1" = colors()[70], "K3AG2" = colors()[60], "K3SG1" = colors()[90],
            "K3SG2" = colors()[40], "K4" = colors()[400], "K5" = colors()[450],
            "K6" = colors()[500], "K7" = colors()[550]
          ))
      }
    }

    y <- year_input()
    errors_by_id <- filter(errors_by_id, production_year == y)
    e <- error_input()
    plots <- list()
    for (i in factory_plots()) {
      plots[[i]] <- pareto(errors_by_id, i, e)
    }
    if (length(plots) == 0) {
      NULL
    } else if (length(plots) <= 4) {
      do.call(plot_grid, c(plots, nrow = 1))
    } else if (length(plots) <= 8) {
      do.call(plot_grid, c(plots, nrow = 2))
    } else {
      do.call(plot_grid, c(plots, nrow = 3))
    }
  })



  output$Linediagram <- renderPlot({
    validate(
      need(input$component, "Please select a component")
    )
    selected_component <- component_input()
    selected_year <- year_line_input()
    df <- data.frame(errors_by_id_week[[selected_component]]) %>%
      filter(production_year == selected_year)
    df$factory <- factor(df$factory)
    ggplot(df, aes(x = df$production_week, group = df$factory)) +
      geom_line(aes(y = df$abs_error, color = df$factory), size = 1) +
      geom_point(aes(y = df$abs_error, color = df$factory), size = 2) +
      geom_line(aes(y = df$total_error, color = "total"), size = 1.3, linetype = "dotted") +
      labs(x = "Production Week", y = "Absolute Error", color = "Factory")
  })


  # Show the basic dataset
  output$dataset <- renderDataTable(rename(errors_by_id, component = id), options = list(pageLength = 10))
}

# Run the application
shinyApp(ui = ui, server = server)
```